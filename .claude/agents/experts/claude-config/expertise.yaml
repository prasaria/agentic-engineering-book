# Claude Code Configuration Expertise
# Target: 400-500 lines | Domain: Operational knowledge for .claude/ configuration

overview:
  description: |
    Claude Code configuration—.claude/ directory structure, command patterns,
    hook implementation, expert 4-agent pattern (expertise.yaml + 4 agents),
    and slash command conventions. This expertise enables correct configuration
    of Claude Code projects.
  scope: |
    Covers .claude/ directory organization (agents/, commands/, hooks/, skills/,
    .cache/, data/), command frontmatter schema, hook types with uv, expert
    4-agent pattern (plan/build/improve/question in agents/experts/<domain>/),
    settings configuration, and naming conventions.

    ARCHITECTURAL NOTE [2025-12-26]: Skills are workflow templates (not agents)
    in .claude/skills/. Flat orchestration - /do directly spawns expert agents.
    Coordinators deprecated (nested subagent limitation). Does NOT cover agent
    prompt content (see agent-authoring expert).
  rationale: |
    Correct .claude/ configuration enables tooling, discoverability, and
    maintainability. Poor structure creates fragmentation and breaks tooling.

core_implementation:
  directory_structure:
    .claude/:
      agents/:
        purpose: Agent definitions (general-purpose + experts/)
        experts/<domain>/:
          purpose: 4-agent pattern (plan/build/improve/question + expertise.yaml)
          pattern: 12 domains × 4 agents = 48 agents total
      commands/:
        purpose: Slash commands by category
        do.md: Universal orchestrator - directly spawns expert agents
      skills/:
        purpose: Workflow templates (NOT agents) - guide /do orchestration
      hooks/:
        purpose: Lifecycle hooks (Python with uv)
        utils/: Hook utility modules
      .cache/:
        purpose: Gitignored ephemeral data
        specs/: Spec files from plan agents
        orchestration-traces.jsonl: Task execution traces
      data/:
        purpose: Session and state data (gitignored)
        sessions/: Session metadata JSON
        learnings/: Captured learnings
        temp/: Cross-hook coordination (timing markers)
      logs/:
        purpose: Session logs and analytics (gitignored)
      settings.json:
        purpose: Project-wide config (committed)
      settings.local.json:
        purpose: Local overrides (gitignored)

  key_files:
    - path: .claude/commands/<category>/<name>.md
      purpose: Slash command (frontmatter + prompt)
      invocation: /category:name
    - path: .claude/agents/experts/<domain>/<domain>-{plan,build,improve,question}-agent.md
      purpose: Expert 4-agent pattern with standardized colors
    - path: .claude/agents/experts/<domain>/expertise.yaml
      purpose: Structured domain knowledge (400-600 lines target, 1000 max)
    - path: .claude/hooks/<hook-name>.py
      purpose: Lifecycle hook with uv shebang
    - path: .claude/skills/<workflow>/SKILL.md
      purpose: Workflow template for /do orchestration

key_operations:
  create_slash_command:
    when: Adding new command functionality
    approach: |
      1. Create .claude/commands/<category>/<name>.md
      2. Add frontmatter:
         ---
         description: Brief command description (required)
         argument-hint: [param1] [param2 (optional)]
         allowed-tools: Tool, List, Here
         ---
      3. Write prompt (Purpose, Variables, Instructions, Workflow, Report)
      4. Invoked as /category:name
    examples:
      - .claude/commands/book/toc.md → /book:toc
      - .claude/commands/knowledge/capture.md → /knowledge:capture
    pitfalls:
      - what: "CRITICAL - Using colons in frontmatter string values"
        instead: "No colons in description, argument-hint, or any YAML value"
        reason: "Colons break YAML parsing in Claude Code's configuration system. Affects ALL frontmatter, not just agents. [2026-01-17]"

  implement_hook:
    when: Need to run code on agent lifecycle events
    events: [SessionStart, UserPromptSubmit, PreToolUse, PostToolUse, SubagentStop, PreCompact, Stop]
    approach: |
      1. Create .claude/hooks/<hook-name>.py with uv shebang:
         #!/usr/bin/env -S uv run --script
         # /// script
         # requires-python = ">=3.8"
         # ///
      2. Implement hook function (read JSON from stdin)
      3. Exit 0 (allow) or 2 (block)
      4. Configure in .claude/settings.json hooks object
      5. Use matcher for tool-specific targeting (reduces overhead)
    examples:
      - pre_tool_use_logger.py: Log tool usage, security guards
      - orchestration_trace_logger.py: PostToolUse with Task matcher only

  create_expert_domain:
    when: Adding new expert domain with queryable expertise
    approach: |
      1. Create .claude/agents/experts/<domain>/
      2. Create expertise.yaml (overview, core_implementation, key_operations,
         decision_trees, patterns, best_practices, known_issues)
      3. Create <domain>-plan-agent.md (sonnet, yellow, Read/Glob/Grep/Write)
      4. Create <domain>-build-agent.md (sonnet, green, Read/Write/Edit/Glob/Grep, +Bash for ops)
      5. Create <domain>-improve-agent.md (sonnet, purple, all tools + Bash for git)
      6. Create <domain>-question-agent.md (haiku, cyan, Read/Glob/Grep only)
    pattern: 4-agent pattern replaces old 3-file triad (expertise + question + self-improve)
    examples:
      - curriculum: 12th domain, absorbed 2 standalone agents (888 lines total)
      - github: Absorbed github-versioning-agent (383 lines)
    pitfalls:
      - what: "CRITICAL - Using colons in agent description field (e.g., 'Expects: SPEC')"
        instead: "Remove colons from description values (use 'Expects SPEC' not 'Expects: SPEC')"
        reason: "Colons in YAML string values cause Claude Code's agent discovery parser to fail silently. Agents with colons in descriptions will NOT appear in /agents list. [2026-01-17] Root cause confirmed via systematic testing across 38 agents."

  configure_settings:
    when: Configuring permissions, hooks, or project behavior
    structure: |
      .claude/settings.json:
      {
        "statusLine": {"type": "command", "command": "..."},
        "permissions": {"allow": ["Read", "Glob"], "deny": []},
        "env": {"VAR": "value"},
        "hooks": {
          "<EventType>": [
            {
              "matcher": {"tool_name": "Task"},  // Optional: tool-specific
              "hooks": [{"type": "command", "command": "...", "timeout": 5000}]
            }
          ]
        }
      }
    notes: |
      - Local overrides in settings.local.json (gitignored)
      - Matcher enables tool-specific hooks (e.g., PostToolUse only for Task)
      - Valid JSON (no trailing commas)

decision_trees:
  command_vs_agent_vs_skill:
    question: What am I creating?
    options:
      - if: User-invoked task with fixed workflow
        then: Slash command (.claude/commands/)
      - if: Model-invoked sub-agent for delegation
        then: Agent (.claude/agents/)
      - if: Workflow template to guide /do orchestration
        then: Skill (.claude/skills/) - NOT an agent
      - if: Domain expertise with plan/build/improve/question
        then: Expert domain (.claude/agents/experts/<domain>/)

  expert_location:
    question: Where to put expert files?
    options:
      - file: Agent files (plan, build, improve, question)
        location: .claude/agents/experts/<domain>/
      - file: Expertise YAML
        location: .claude/agents/experts/<domain>/expertise.yaml
      - file: Spec files from plan agents
        location: .claude/.cache/specs/<domain>/

patterns:
  expert_domain_4agent:
    structure: |
      .claude/agents/experts/<domain>/
      ├── expertise.yaml (400-600 lines target, 1000 max)
      ├── <domain>-plan-agent.md (yellow, Read/Glob/Grep/Write)
      ├── <domain>-build-agent.md (green, Read/Write/Edit/Glob/Grep, +Bash for ops)
      ├── <domain>-improve-agent.md (purple, all + Bash for git analysis)
      └── <domain>-question-agent.md (cyan, Read/Glob/Grep, haiku model)
    color_coding:
      plan: yellow (analysis, planning)
      build: green (creation, implementation)
      improve: purple (review, expertise evolution)
      question: cyan (meta, read-only Q&A)
    trade_offs:
      pros: [Plan→build→improve lifecycle with approval gates, Color-coded roles, Expertise evolves via git analysis]
      cons: [5 files vs 3 (old pattern), More complexity than standalone agents]

  skill_as_workflow_template:
    structure: |
      .claude/skills/<workflow>/SKILL.md (NO agent frontmatter)
      ---
      name: workflow-name
      description: Use when... Triggers on "keyword".
      ---
      # Workflow steps as documentation
    purpose: Guide /do orchestration (not executable agent)
    trade_offs:
      pros: [Eliminates nested subagent limitation, Easier to maintain than agent code]
      cons: [No programmatic workflow enforcement, /do centralized complexity]

  hook_coordination_via_temp_files:
    use_case: PreToolUse and PostToolUse need to share state (e.g., timing)
    pattern: |
      PreToolUse writes → PostToolUse reads → cleanup
      - .claude/data/temp/<session-id>-task-timing.txt
      - PostToolUse unlink() after read
    examples:
      - pre_tool_use_logger.py writes timing marker
      - orchestration_trace_logger.py reads, calculates latency, deletes file

  orchestration_observability:
    purpose: Capture Task tool invocations for meta-improvement
    implementation: |
      1. PostToolUse hook with Task matcher in settings.json
      2. Extract metadata (agent name, phase, domain, workflow_type)
      3. Calculate latency (via PreToolUse coordination)
      4. Append to .claude/.cache/orchestration-traces.jsonl
    trace_schema:
      timestamp: ISO 8601
      session_id: UUID
      agent_name: e.g., knowledge-build-agent
      phase: [plan, build, improve, question]
      domain: [knowledge, github, curriculum, ...]
      workflow_type: expert
      latency_ms: integer
      success: boolean
      total_tokens: integer

best_practices:
  organization:
    - Agents in .claude/agents/, commands in .claude/commands/
    - Expert domains: agents/experts/<domain>/ (4-agent + expertise.yaml)
    - Skills: .claude/skills/ as workflow templates (NOT agents)
    - Specs: .claude/.cache/specs/ (gitignored ephemeral)
    - Expertise.yaml: 400-600 lines target, 1000 hard limit

  commands:
    - Naming: category:command pattern (/book:toc)
    - Frontmatter: description (required), argument-hint, allowed-tools
    - Use allowed-tools to restrict capabilities per command
    - CRITICAL: Never use colons in frontmatter string values (breaks YAML parsing)

  expert_domains:
    - Standardized color coding (yellow/green/purple/cyan)
    - Question agents: haiku model, read-only tools
    - Improve agents: Bash for git history analysis
    - Absorb standalone agents >300 lines into expert domains
    - CRITICAL: Never use colons in description field (breaks agent discovery)

  hooks:
    - uv shebang for Python dependencies
    - Configure in settings.json by event type
    - Exit 0 (allow), 2 (block)
    - Matcher for tool-specific hooks (reduces overhead)
    - Temp files in .claude/data/temp/ for cross-hook coordination
    - Cleanup temp files after read (unlink)

  settings:
    - settings.json: project-wide (committed)
    - settings.local.json: local overrides (gitignored)
    - Valid JSON (no trailing commas)

  observability:
    - JSONL for append-only trace logs
    - Extract structured metadata from agent names
    - Store traces in .claude/.cache/ (gitignored)

known_issues:
  - issue: No automated validation of command frontmatter
    workaround: Manual review during command creation
    status: open

  - issue: Spec files in .claude/.cache/specs/ accumulate
    workaround: Manual cleanup (gitignored, non-critical)
    status: open

  - issue: Hook errors not always visible
    workaround: Explicit logging in hooks
    status: open

  - issue: Colons in frontmatter string values break YAML parsing
    impact: Agents/commands with colons in description field fail discovery silently
    resolution: |
      Fix b6a2b47 removed colons from 38 agent descriptions across 12 domains.
      Pattern changed from 'Expects: SPEC' to 'Expects SPEC'.
      Root cause: Claude Code YAML parser treats unquoted colons as key-value separators.
    prevention: Lint rule or validation check needed
    status: resolved [2026-01-17]

  - issue: Nested subagent limitation (coordinators couldn't spawn experts)
    resolution: Flat orchestration - /do directly spawns expert agents (commit 353d576)
    status: resolved

  - issue: Old 3-file expert pattern mixed location concerns
    resolution: 4-agent pattern in agents/experts/ (all 12 domains migrated)
    status: resolved

potential_enhancements:
  - Automated frontmatter validation for commands (low effort)
  - Command discovery interface - list all commands (low effort)
  - Spec file cleanup automation (low effort)
  - Hook debugging mode for visible errors (medium effort)
  - Orchestration trace aggregation tool for latency stats (low effort)
  - Temp file orphan cleanup on SessionStart (low effort)

stability:
  convergence_indicators:
    insight_rate_trend: decreasing
    contradiction_count: 0
    last_reviewed: 2026-01-17
    notes: |
      Domain reached critical stability - frontmatter colon bug discovered and resolved.
      Major architectural patterns converged (flat orchestration, 4-agent pattern).
      Insight rate declining as fundamental patterns stabilize.
