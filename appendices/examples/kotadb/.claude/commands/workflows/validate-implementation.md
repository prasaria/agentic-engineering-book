# /validate-implementation

**Template Category**: Action

Run repository validation gates after implementation. Choose the correct level based on scope using KotaDB's Bun tooling.

## Quick Reference

All commands assume `app/` as working directory. Levels 2-3 require Docker and Supabase Local stack.

```bash
# Level 1 – Quick Gate (≤ 1 minute)
cd app && bun run lint
cd app && bunx tsc --noEmit

# Level 2 – Integration Gate (3-5 minutes)
cd app && bun run lint
cd app && bunx tsc --noEmit
cd app && bun test:setup
cd app && bun test --filter integration
cd app && bun test:teardown || true

# Level 3 – Release Gate (6-8 minutes)
cd app && bun run lint
cd app && bunx tsc --noEmit
cd app && bun test:setup
cd app && bun test --filter integration
cd app && bun test
cd app && bun test:teardown || true
cd app && bun run build
```

## Level Selection Guide

| Change Type                          | Level | Commands to Run                                          |
| ------------------------------------ | ----- | -------------------------------------------------------- |
| Docs-only, configuration comments    | 1     | `lint + typecheck` (no test environment required)        |
| Core logic, new endpoints, bug fixes | 2     | `lint + typecheck + test:setup + integration tests + test:teardown` |
| Release prep, migrations, auth flows | 3     | `lint + typecheck + test:setup + all tests + test:teardown + build` |

## Environment Prerequisites

**Levels 2-3 require Docker and Supabase Local stack.** Verify before running:

```bash
# Check Docker installation
command -v docker &> /dev/null || echo "ERROR: Install Docker Desktop"

# Check Docker daemon status
docker info &> /dev/null 2>&1 || echo "ERROR: Start Docker Desktop"
```

| Variable / Service        | Why It Matters                                        | Notes |
| ------------------------- | ----------------------------------------------------- | ----- |
| Docker Desktop            | Runs Supabase Local containers for tests              | Required for Level 2+; see https://docs.docker.com/get-docker/ |
| `SUPABASE_URL`            | Points tests at Supabase Local (auto-generated)       | Set by `bun test:setup`; do **not** hardcode in tests |
| `SUPABASE_SERVICE_KEY`    | Authenticates test database queries                   | Auto-generated by `bun test:setup` |
| Background job processor  | Ensures async flows run during integration suites     | Start any required workers before Level 2+ |
| Observability (logs, etc) | Capture evidence that real services ran during tests | Attach snippets in PR report |

**Reference**: `.claude/commands/docs/test-lifecycle.md` for complete Docker setup and troubleshooting.

## Level Details

### Level 1 – Quick Gate
- Use when touching documentation or configuration comments only.
- Confirms lint + types stay clean; no automated tests beyond type safety.
- Expected duration: under one minute.

### Level 2 – Integration Gate
- Default for feature and bug work; mandates `/anti-mock` compliance.
- Starts Supabase Local stack with `bun test:setup` before running tests.
- Runs integration-focused specs with `bun test --filter integration`, exercising real Supabase database.
- Cleans up containers with `bun test:teardown || true` after tests complete.
- Capture Supabase query logs or other proof that real services were hit.

### Level 3 – Release Gate
- Required for schema, authentication, billing, or other high-risk paths.
- Starts Supabase Local stack with `bun test:setup` before running tests.
- Executes Level 2 integration tests plus full test suite (`bun test`) and build.
- Cleans up containers with `bun test:teardown || true` after tests complete.
- Ensure background workers and webhooks are active so flows are validated end-to-end.

## How to Use

1. Resolve plan tasks, add/update tests, and ensure fixtures are committed with real-service coverage (see `/anti-mock`).
2. Select the appropriate level from the table above (features/bugs default to Level 2; infra-critical tasks require Level 3).
3. **For Level 2-3**: Verify Docker is available before starting validation.
4. Run commands in order. Stop immediately to fix failures before proceeding.
5. Capture command summaries for handoff (test counts, Supabase evidence, notable warnings).
6. Document the level executed and outcomes in your report or PR body, explicitly noting which real-service suites ran.

## Troubleshooting

- **Lint errors**: `bun run lint --apply` for autofix-able issues; manually address remaining failures.
- **Type errors**: inspect the reported file and re-run `bun run typecheck` after fixes.
- **Docker errors**: See `.claude/commands/docs/test-lifecycle.md` for Docker prerequisite checks and troubleshooting.
- **Connection errors**: Run `cd app && bun test:setup` to ensure Supabase containers are running.
- **Port conflicts**: Run `cd app && bun test:teardown` to clean up stale containers.
- **Tests**: scope with `bun test <pattern>` while debugging, then re-run the full suite.
- **Build**: fix type or runtime import errors surfaced during `bun run build`.

## Git Flow Alignment

- Branches follow `feat/|bug/|chore/` → `develop` → `main`.
- Run validation before committing, before pushing, and again ahead of PR creation (Level 2 minimum).
- Include validation evidence in `/pull_request` and `/pr-review` outputs for traceability.
